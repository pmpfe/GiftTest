name: Build Cross-Platform Releases

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile `
            --windowed `
            --name "GiftTestPractice" `
            --icon="assets/icon.ico" `
            --add-data "data:data" `
            --distpath "./dist-windows" `
            gift_test_practice.py
      
      - name: Create Windows Installer with NSIS
        uses: joncloud/makensis-action@v3.7
        with:
          script-file: "packaging/windows/installer.nsi"
        continue-on-error: true
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GiftTestPractice-Windows
          path: |
            dist-windows/
            packaging/windows/*.exe
          retention-days: 30

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile \
            --windowed \
            --name "GiftTestPractice" \
            --icon="assets/icon.icns" \
            --add-data "data:data" \
            --distpath "./dist-macos" \
            gift_test_practice.py
      
      - name: Create DMG installer
        run: |
          mkdir -p packaging/macos/dmg-tmp
          mkdir -p packaging/macos
          cp -r dist-macos/GiftTestPractice.app packaging/macos/dmg-tmp/
          ln -s /Applications packaging/macos/dmg-tmp/Applications
          hdiutil create -volname "GiftTestPractice" \
            -srcfolder packaging/macos/dmg-tmp \
            -ov -format UDZO \
            packaging/macos/GiftTestPractice.dmg
      
      - name: Sign and notarize (optional - requires Apple Developer account)
        continue-on-error: true
        run: |
          # Add your signing and notarization steps here
          echo "Signing skipped - configure with your Apple Developer credentials"
      
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GiftTestPractice-macOS
          path: |
            dist-macos/
            packaging/macos/*.dmg
          retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpython3-dev fpm
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile \
            --name "gift-test-practice" \
            --add-data "data:data" \
            --distpath "./dist-linux" \
            gift_test_practice.py
      
      - name: Create DEB package
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          if [ -z "$VERSION" ]; then VERSION="0.0.1"; fi
          mkdir -p packaging/linux/deb-build/usr/bin
          mkdir -p packaging/linux/deb-build/usr/share/applications
          mkdir -p packaging/linux/deb-build/usr/share/pixmaps
          mkdir -p packaging/linux
          cp dist-linux/gift-test-practice packaging/linux/deb-build/usr/bin/
          cp packaging/linux/gift-test-practice.desktop packaging/linux/deb-build/usr/share/applications/
          cp assets/icon.png packaging/linux/deb-build/usr/share/pixmaps/gift-test-practice.png
          
          fpm -s dir -t deb \
            -n gift-test-practice \
            -v "$VERSION" \
            --description "GIFT Test Practice Application" \
            --maintainer "pmpfe@github" \
            -C packaging/linux/deb-build \
            -o packaging/linux/
      
      - name: Create RPM package
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          if [ -z "$VERSION" ]; then VERSION="0.0.1"; fi
          mkdir -p packaging/linux/rpm-build/usr/bin
          mkdir -p packaging/linux/rpm-build/usr/share/applications
          mkdir -p packaging/linux/rpm-build/usr/share/pixmaps
          cp dist-linux/gift-test-practice packaging/linux/rpm-build/usr/bin/
          cp packaging/linux/gift-test-practice.desktop packaging/linux/rpm-build/usr/share/applications/
          cp assets/icon.png packaging/linux/rpm-build/usr/share/pixmaps/gift-test-practice.png
          
          fpm -s dir -t rpm \
            -n gift-test-practice \
            -v "$VERSION" \
            --description "GIFT Test Practice Application" \
            --maintainer "pmpfe@github" \
            -C packaging/linux/rpm-build \
            -o packaging/linux/
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GiftTestPractice-Linux
          path: |
            dist-linux/
            packaging/linux/*.deb
            packaging/linux/*.rpm
          retention-days: 30

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts/
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: all-artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
